$(document).ready(function(){return d3.csv("stat.csv",function(t){function e(t,e){return e.order-t.order}var r,n,o,a,c,i,l,s,u,d,f,p,m,h,g,v,x,N,b,I,y,A,k,w,z,H,S,$,j,q;for(console.log(t),r={},n=[],o=39,a=2e3,c={remain:"#67b238",icu:"#efb639",danger:"#e13123",ecmo:"#771d18",death:"#333333"},i={remain:"一般病房",icu:"加護病房",danger:"病危",ecmo:"使用葉克膜",death:"死亡"},l={remain:0,icu:1,danger:2,ecmo:3,death:4},s=0,u=t.length;u>s;++s){for(d=t[s],f=d["日期"],n.push(f),p=parseInt(d["加護病房"]),m=parseInt(d["病危數"]),h=parseInt(d["葉克膜"]),g=parseInt(d["死亡"]),v=parseInt(d["傷患數"]),isNaN(h)||(p-=h,isNaN(m)||(m-=h)),isNaN(m)||(p-=m),x=[],N=0;p>N;++N)b=N,x.push({icu:!0,color:c.icu,order:l.icu});for(N=0;m>N;++N)b=N,x.push({danger:!0,color:c.danger,order:l.danger});for(N=0;h>N;++N)b=N,x.push({ecmo:!0,color:c.ecmo,order:l.ecmo});for(N=0;g>N;++N)b=N,x.push({death:!0,color:c.death,order:l.death});for(I=v-x.length,N=0;I>N;++N)b=N,x.push({color:c.remain,order:l.remain});for(x.sort(e),N=0,y=x.length;y>N;++N)A=x[N],k=tinycolor(A.color).toHsl(),k.l=k.l/2,A.border=tinycolor(k).toHexString();isNaN(h)||(isNaN(m)||(m+=h),p+=h),isNaN(m)||(p+=m),r[f]={date:f,count:v,icu:p,danger:m,ecmo:h,death:g,list:x,remain:I}}return w=["#dcd38e","#cda06a","#c67f39","#bc6029","#b1270b","#6c090e"],z=d3.scale.ordinal().domain(function(){var t,e,r=[];for(t=0,e=100/(w.length-1);0>e?t>=100:100>=t;t+=e)r.push(t);return r}()).range(w),H=function(t){var e,r,n,a,l,s,u,d,f;return e=t.list,r=d3.select("#legend").selectAll("g").data(function(){var e,r=[];for(n in e=c)a=e[n],r.push({name:i[n],color:[a],count:t[n]});return r}()),l=r.enter().append("g"),l.append("circle").attr({cx:function(t,e){return 80*e},cy:0,r:10,fill:function(t){return t.color}}),s=l.append("text"),s.attr({x:function(t,e){return 80*e},y:20,fill:"#ddd","dominant-baseline":"central","text-anchor":"middle","font-size":12}),s.text(function(t){return t.name}),u=l.append("text"),u.attr({"class":"count",x:function(t,e){return 80*e},y:35,fill:"#ddd","dominant-baseline":"central","text-anchor":"middle","font-size":12}),d3.select("#legend").selectAll("g").select("text.count").text(function(t){return isNaN(t.count)?"-":t.count}),d=d3.select("#svg").selectAll("g.victim").data(e),f=d.enter().append("g"),f.attr({"class":"victim",transform:function(t,e){var r,n;return r=e%o,n=parseInt(e/o),"translate("+180*r+" "+360*n+") scale(1.0)"}}),f.append("rect").attr({width:180,x:0,"clip-path":"url(#clip-man)"}),f.append("use").attr({x:0,y:0,stroke:"#720","stroke-width":8,fill:function(){return"#000"},"xlink:href":"#shape-man",filter:"url(#shadow)"}),d.exit().remove(),d},S=function(){return d3.select("#svg").selectAll("g.victim").transition().duration(a/2).attr({transform:function(t,e){var r,n;return r=e%o,n=parseInt(e/o),"translate("+20*r+" "+35*n+") scale(0.1)"}}),d3.select("#svg").selectAll("g.victim").select("use").transition().duration(a/2).attr({fill:function(t){return t.color},stroke:function(t){return t.border}})},$=function(t){return d3.select("#text").text("2015 "+t),H(r[t]),S()},j=0,q=function(){return $(n[j]),j=(j+1)%n.length},setInterval(function(){return q()},a),q()})});