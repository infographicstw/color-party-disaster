$(document).ready(function(){return d3.csv("stat.csv",function(t){function e(t,e){return e.order-t.order}var r,n,o,a,c,i,l,u,s,d,f,p,h,m,g,v,x,y,N,b,w,I,A,k,z,H,S,$,j,q,B;for(console.log(t),r={},n=[],o=39,a=2500,c={remain:"#67b238",icu:"#efb639",danger:"#e13123",ecmo:"#771d18",death:"#333333"},i={remain:"一般病房",icu:"加護病房",danger:"病危",ecmo:"使用葉克膜",death:"死亡"},l={remain:0,icu:1,danger:2,ecmo:3,death:4},u=0,s=t.length;s>u;++u){for(d=t[u],f=d["日期"],n.push(f),p=parseInt(d["加護病房"]),h=parseInt(d["病危數"]),m=parseInt(d["葉克膜"]),g=parseInt(d["死亡"]),v=parseInt(d["傷患數"]),isNaN(m)||(p-=m,isNaN(h)||(h-=m)),isNaN(h)||(p-=h),x=[],y=0;p>y;++y)N=y,x.push({icu:!0,color:c.icu,order:l.icu});for(y=0;h>y;++y)N=y,x.push({danger:!0,color:c.danger,order:l.danger});for(y=0;m>y;++y)N=y,x.push({ecmo:!0,color:c.ecmo,order:l.ecmo});for(y=0;g>y;++y)N=y,x.push({death:!0,color:c.death,order:l.death});for(b=v-x.length,y=0;b>y;++y)N=y,x.push({color:c.remain,order:l.remain});for(x.sort(e),y=0,w=x.length;w>y;++y)I=x[y],A=tinycolor(I.color).toHsl(),A.l=A.l/2,I.border=tinycolor(A).toHexString();isNaN(m)||(isNaN(h)||(h+=m),p+=m),isNaN(h)||(p+=h),r[f]={date:f,count:v,icu:p,danger:h,ecmo:m,death:g,list:x,remain:b}}return k=["#dcd38e","#cda06a","#c67f39","#bc6029","#b1270b","#6c090e"],z=d3.scale.ordinal().domain(function(){var t,e,r=[];for(t=0,e=100/(k.length-1);0>e?t>=100:100>=t;t+=e)r.push(t);return r}()).range(k),H=function(t){var e,r,n,a,l,u,s,d,f;return e=t.list,r=d3.select("#legend").selectAll("g").data(function(){var e,r=[];for(n in e=c)a=e[n],r.push({name:i[n],color:[a],count:t[n]});return r}()),l=r.enter().append("g"),l.append("circle").attr({cx:function(t,e){return 80*e},cy:0,r:10,fill:function(t){return t.color}}),u=l.append("text"),u.attr({x:function(t,e){return 80*e},y:20,fill:"#ddd","dominant-baseline":"central","text-anchor":"middle","font-size":12}),u.text(function(t){return t.name}),s=l.append("text"),s.attr({"class":"count",x:function(t,e){return 80*e},y:35,fill:"#ddd","dominant-baseline":"central","text-anchor":"middle","font-size":12}),d3.select("#legend").selectAll("g").select("text.count").text(function(t){return isNaN(t.count)?"-":t.count}),d=d3.select("#svg").selectAll("g.victim").data(e),f=d.enter().append("g"),f.attr({"class":"victim",transform:function(t,e){var r,n;return r=e%o,n=parseInt(e/o),"translate("+20*r+" "+35*n+") scale(0.1)"}}),f.style({opacity:0}),f.append("rect").attr({width:180,x:0,"clip-path":"url(#clip-man)"}),f.append("use").attr({x:0,y:0,stroke:"#720","stroke-width":8,fill:function(){return"#000"},"xlink:href":"#shape-man",filter:"url(#shadow)"}),d.exit().attr({"class":""}).transition().duration(1e3).style({opacity:0}).remove(),d},S=function(){return d3.select("#svg").selectAll("g.victim").style({opacity:1}),d3.select("#svg").selectAll("g.victim").select("use").style({fill:function(t){return t.color},stroke:function(t){return t.border}})},$=function(t){return d3.select("#text").text("2015 "+t),H(r[t]),S()},j=0,q=!0,B=function(){return $(n[j]),j=(j+1)%n.length},setInterval(function(){return q?B():void 0},a),B(),window.move={state:function(t){return q=!!t,d3.select("#arrow-play path").attr({fill:function(){return q?"#fff":"#666"}}),d3.select("#arrow-pause path").attr({fill:function(){return q?"#666":"#fff"}})},left:function(){return j=(j-2+n.length)%n.length,B()},right:function(){return B()}},window.move.state(q)})});