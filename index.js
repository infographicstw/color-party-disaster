$(document).ready(function(){return d3.csv("stat.csv",function(t){function e(t,e){return e.order-t.order}var n,r,o,c,a,i,l,s,u,d,f,p,h,m,g,v,x,y,N,b,w,I,A,k,z,H,S,$,j,q,B,C;for(console.log(t),n={},r=[],o=39,c=2500,a={remain:"#67b238",icu:"#efb639",danger:"#e13123",ecmo:"#771d18",death:"#333333"},i={remain:"一般病房",icu:"加護病房",danger:"病危",ecmo:"使用葉克膜",death:"死亡"},l={remain:0,icu:1,danger:2,ecmo:3,death:4},s=0,u=t.length;u>s;++s){for(d=t[s],f=d["日期"],r.push(f),p=parseInt(d["加護病房"]),h=parseInt(d["病危數"]),m=parseInt(d["葉克膜"]),g=parseInt(d["死亡"]),v=parseInt(d["留院數"]),x=d["備註"],isNaN(m)||(p-=m,isNaN(h)||(h-=m)),isNaN(h)||(p-=h),y=[],N=0;p>N;++N)b=N,y.push({icu:!0,color:a.icu,order:l.icu});for(N=0;h>N;++N)b=N,y.push({danger:!0,color:a.danger,order:l.danger});for(N=0;m>N;++N)b=N,y.push({ecmo:!0,color:a.ecmo,order:l.ecmo});for(N=0;g>N;++N)b=N,y.push({death:!0,color:a.death,order:l.death});for(w=v-y.length,N=0;w>N;++N)b=N,y.push({color:a.remain,order:l.remain});for(y.sort(e),N=0,I=y.length;I>N;++N)A=y[N],k=tinycolor(A.color).toHsl(),k.l=k.l/2,A.border=tinycolor(k).toHexString();isNaN(m)||(isNaN(h)||(h+=m),p+=m),isNaN(h)||(p+=h),n[f]={date:f,count:v,icu:p,danger:h,ecmo:m,death:g,list:y,remain:w,note:x}}return z=["#dcd38e","#cda06a","#c67f39","#bc6029","#b1270b","#6c090e"],H=d3.scale.ordinal().domain(function(){var t,e,n=[];for(t=0,e=100/(z.length-1);0>e?t>=100:100>=t;t+=e)n.push(t);return n}()).range(z),S=function(t){var e,n,r,c,l,s,u,d,f;return e=t.list,d3.select("#note-text").text(t.note||""),n=d3.select("#legend").selectAll("g").data(function(){var e,n=[];for(r in e=a)c=e[r],n.push({name:i[r],color:[c],count:t[r]});return n}()),l=n.enter().append("g"),l.append("circle").attr({cx:function(t,e){return 80*e},cy:0,r:10,fill:function(t){return t.color}}),s=l.append("text"),s.attr({x:function(t,e){return 80*e},y:20,fill:"#ddd","dominant-baseline":"central","text-anchor":"middle","font-size":12}),s.text(function(t){return t.name}),u=l.append("text"),u.attr({"class":"count",x:function(t,e){return 80*e},y:35,fill:"#ddd","dominant-baseline":"central","text-anchor":"middle","font-size":12}),d3.select("#legend").selectAll("g").select("text.count").text(function(t){return isNaN(t.count)?"-":t.count}),d=d3.select("#svg").selectAll("g.victim").data(e),f=d.enter().append("g"),f.attr({"class":"victim",transform:function(t,e){var n,r;return n=e%o,r=parseInt(e/o),"translate("+20*n+" "+35*r+") scale(0.1)"}}),f.style({opacity:0}),f.append("rect").attr({width:180,x:0,"clip-path":"url(#clip-man)"}),f.append("use").attr({x:0,y:0,stroke:"#720","stroke-width":8,fill:function(){return"#000"},"xlink:href":"#shape-man",filter:"url(#shadow)"}),d.exit().attr({"class":""}).transition().duration(1e3).style({opacity:0}).remove(),d},$=function(){return d3.select("#svg").selectAll("g.victim").style({opacity:1}),d3.select("#svg").selectAll("g.victim").select("use").style({fill:function(t){return t.color},stroke:function(t){return t.border}})},j=function(t){return d3.select("#text").text("2015 "+t),S(n[t]),$()},q=0,B=!0,C=function(){return j(r[q]),q=(q+1)%r.length},setInterval(function(){return B?C():void 0},c),C(),window.move={state:function(t){return B=!!t,d3.select("#arrow-play path").attr({fill:function(){return B?"#fff":"#666"}}),d3.select("#arrow-pause path").attr({fill:function(){return B?"#666":"#fff"}})},left:function(){return q=(q-2+r.length)%r.length,C()},right:function(){return C()}},window.move.state(B)})});